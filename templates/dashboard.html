<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
    <h1>Welcome, {{ current_user.username }}</h1>
    <form method="POST">
        <label for="symbol">Select Symbol (e.g., AAPL for stock, EUR/USD for forex):</label>
        <input type="text" id="symbol" name="symbol" value="{{ symbol or '' }}" required>
        <button type="submit">Update Symbol</button>
    </form>
    <div id="signal-container"></div>
    <div id="performance-container"></div>
    
    <!-- TradingView Chart Container -->
    <div id="tradingview_chart" style="width:100%; height:600px;"></div>

    <script>
        function getSignal() {
            fetch('/get_signal')
                .then(response => response.json())
                .then(data => {
                    console.log('Signal data:', data);
                    if (data.error) {
                        document.getElementById('signal-container').innerHTML = data.error;
                    } else {
                        document.getElementById('signal-container').innerHTML = 
                            `Signal for ${data.symbol}: ${data.signal}<br>
                            Entry: ${data.entry.toFixed(4)}<br>
                            Stop: ${data.stop.toFixed(4)}<br>
                            Target: ${data.target.toFixed(4)}`;
                        loadTradingViewChart(data.symbol, data.historical_signals, data.entry, data.stop, data.target);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function getPerformance() {
            // ... (keep existing getPerformance function)
        }

        function loadTradingViewChart(symbol, historicalSignals, entry, stop, target) {
            document.getElementById('tradingview_chart').innerHTML = ''; // Clear previous chart
            new TradingView.widget({
                "width": "100%",
                "height": 600,
                "symbol": symbol.includes('/') ? symbol.replace('/', '') : symbol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": "tradingview_chart",
                "studies": [
                    {"id": "MASimple@tv-basicstudies", "inputs": {"length": 5, "source": "high"}},
                    {"id": "MASimple@tv-basicstudies", "inputs": {"length": 5, "source": "low"}},
                ],
                "studies_overrides": {
                    "rsi.plot.color": "#FF0000",
                    "macd.macd.color": "#0000FF",
                    "macd.signal.color": "#FF0000"
                },
                "overrides": {
                    "mainSeriesProperties.candleStyle.upColor": "#00ff00",
                    "mainSeriesProperties.candleStyle.downColor": "#ff0000"
                },
                "loading_screen": { "backgroundColor": "#ffffff" },
                "drawings": [
                    ...historicalSignals.map(signal => ([
                        {
                            "type": "icon",
                            "icon": signal.type === "BUY" ? "circle" : "triangle",
                            "color": signal.type === "BUY" ? "#00FF00" : "#FF0000",
                            "position": "aboveBar",
                            "time": signal.time,
                            "price": signal.price
                        },
                        ...(signal.stop !== null ? [{
                            "type": "icon",
                            "icon": "square",
                            "color": "#FF0000",
                            "position": "belowBar",
                            "time": signal.time,
                            "price": signal.stop
                        }] : []),
                        ...(signal.target !== null ? [{
                            "type": "icon",
                            "icon": "diamond",
                            "color": "#0000FF",
                            "position": "belowBar",
                            "time": signal.time,
                            "price": signal.target
                        }] : [])
                    ])).flat(),
                    {
                        "type": "horizontal_line",
                        "price": entry,
                        "color": "#000000",
                        "linewidth": 2,
                        "linestyle": 0,
                        "text": "Entry"
                    },
                    {
                        "type": "horizontal_line",
                        "price": stop,
                        "color": "#FF0000",
                        "linewidth": 2,
                        "linestyle": 2,
                        "text": "Stop"
                    },
                    {
                        "type": "horizontal_line",
                        "price": target,
                        "color": "#0000FF",
                        "linewidth": 2,
                        "linestyle": 2,
                        "text": "Target"
                    }
                ]
            });

            // Add RSI and MACD in separate panes
            widget.chart().createStudy('RSI', false, false, [14], null, {"priceScale": {"scaleMargins": {"top": 0.8, "bottom": 0}}});
            widget.chart().createStudy('MACD', false, false, [12, 26, 9], null, {"priceScale": {"scaleMargins": {"top": 0.1, "bottom": 0}}});
        }

        // Initial load of chart with default or selected symbol
        getSignal();
        getPerformance();

        // Update every 5 minutes
        setInterval(() => {
            getSignal();
            getPerformance();
        }, 300000);
    </script>
</body>
</html>